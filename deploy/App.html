<!DOCTYPE html>
<html>
<head>
    <title>PI State Allocation</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.override(Rally.ui.chart.Chart,{onRender:function(){this.callParent(arguments),this._unmask()}});
                Ext.define("Rally.technicalservices.logger",{constructor:function(config){Ext.apply(this,config)},log:function(args){var output_args=[];if(0===arguments.length)return window.console&&console.log(arguments),void 0;if(1===arguments.length)output_args=arguments;else{var src_class=arguments[0],class_name="";"string"==typeof src_class?class_name=src_class:"function"==typeof src_class.getName?class_name=src_class.getName():"function"==typeof src_class.self.getName&&(class_name=src_class.self.getName()),output_args=Ext.Array.push(output_args,[class_name,"--"]),output_args=Ext.Array.push(output_args,Ext.Array.slice(arguments,1))}window.console&&console.log.apply(console,output_args)}});
                Ext.define("Tls.InvestmentCategories",{extend:"Rally.app.App",componentCls:"app",stateful:!0,logger:new Rally.technicalservices.logger,_selected_base_records:[],_direct_children:[],_selected_iteration:null,_selected_tags:[],category_field_name:"InvestmentCategory",thisState:null,getSettingsFields:function(){return[{name:"piTypes",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],allowBlank:!1,editable:!1,autoSelect:!1,validateOnChange:!1,validateOnBlur:!1,fieldLabel:"Type",shouldRespondToScopeChange:!0,context:this.getContext(),storeConfig:{model:"TypeDefinition",sorters:[{property:"DisplayName"}],fetch:["DisplayName","TypePath"],filters:[{property:"Parent.Name",operator:"=",value:"Portfolio Item"},{property:"Creatable",operator:"=",value:"true"}],autoLoad:!1,remoteSort:!1,sortOnLoad:!0,remoteFilter:!0},displayField:"DisplayName",valueField:"TypePath",listeners:{change:function(combo){combo.fireEvent("typeselected",combo.getValue(),combo.context)},ready:function(combo){combo.fireEvent("typeselected",combo.getValue(),combo.context)}},bubbleEvents:["typeselected"],readyEvent:"ready",handlesEvents:{projectscopechanged:function(context){this.refreshWithNewContext(context)}}},{name:"stackBy",fieldLabel:"Stack",xtype:"combobox",width:300,store:Ext.create("Ext.data.Store",{fields:["name","value"],data:[{name:"By Child",value:"child"},{name:"By Investment Category",value:"category"}]}),displayField:"name",valueField:"value",allowBlank:!1},{name:"chartMetric",fieldLabel:"Chart Metric",xtype:"combobox",width:300,store:Ext.create("Ext.data.Store",{fields:["name","value"],data:[{name:"By Points",value:"points"},{name:"By Count",value:"count"}]}),displayField:"name",valueField:"value",allowBlank:!1},{type:"query"}]},items:[{xtype:"container",itemId:"selector_box",padding:5,layout:{type:"hbox"},defaults:{margin:5},items:[{xtype:"container",itemId:"pi_selector_box"},{xtype:"container",itemId:"chart_selector_box"},{xtype:"container",items:[{xtype:"container",itemId:"iteration_selector_box"},{xtype:"container",itemId:"tag_selector_box"}]}]},{xtype:"container",itemId:"configuration_reporter_box",defaults:{margin:5},padding:5,items:[{xtype:"container",itemId:"selected_pi_box"},{xtype:"container",itemId:"selected_iteration_box"},{xtype:"container",itemId:"selected_tag_box"},{xtype:"container",itemId:"selected_metric_box"}]},{xtype:"container",layout:{type:"hbox"},margin:5,items:[{xtype:"container",itemId:"actual_chart_box",height:500}]}],launch:function(){this._addSelectors(),this._renewState()},_addSelectors:function(){this._addTypePicker(),this._addPIButton(),this._addIterationDatePickers(),this._addTagPicker(),this._addMetricPicker(),this._addChartButton()},_addTagPicker:function(){var me=this;this.down("#tag_selector_box").add({itemId:"tag_selector",xtype:"rallytagpicker",fieldLabel:"with tag(s)",autoExpand:!1,listeners:{selectionchange:function(){me._populateConfigurationReporter()}}})},_addTypePicker:function(){var me=this;this.down("#pi_selector_box").add({itemId:"type_selector",xtype:"rallyportfolioitemtypecombobox",fieldLabel:"PI Type:",storeConfig:{filters:[{property:"Ordinal",operator:">",value:0}]},labelWidth:50,listeners:{change:function(){me._selected_base_records=[],me._populateConfigurationReporter()}}})},_addMetricPicker:function(){var me=this,metrics=Ext.create("Ext.data.Store",{fields:["name","value"],data:[{name:"By Points",value:"points"},{name:"By Count",value:"count"},{name:"By Hours",value:"hours"},{name:"By Cost",value:"cost"}]}),stacks=Ext.create("Ext.data.Store",{fields:["name","value"],data:[{name:"By Child",value:"child"},{name:"By Investment Category",value:"category"}]});this.down("#chart_selector_box").add({itemId:"metric_selector",xtype:"combobox",fieldLabel:"Chart metric:",store:metrics,displayField:"name",valueField:"value",labelWidth:50,listeners:{change:function(){me._populateConfigurationReporter()}}}).setValue("points"),this.down("#chart_selector_box").add({itemId:"stack_selector",xtype:"combobox",fieldLabel:"Stack:",store:stacks,displayField:"name",valueField:"value",labelWidth:50,listeners:{change:function(){me._populateConfigurationReporter()}}}).setValue("category"),this.down("#chart_selector_box").add({itemId:"cost_selector",xtype:"rallynumberfield",fieldLabel:"Cost Multiplier ($):",labelWidth:50,listeners:{change:function(){me._populateConfigurationReporter()}}}).setValue(125)},_addIterationDatePickers:function(){var me=this;this.down("#iteration_selector_box").add({itemId:"iteration_start_selector",xtype:"rallydatefield",fieldLabel:"Iterations starting after",listeners:{change:function(){me._populateConfigurationReporter()}}}),this.down("#iteration_selector_box").add({itemId:"iteration_end_selector",xtype:"rallydatefield",fieldLabel:"Iterations ending before",listeners:{change:function(){me._populateConfigurationReporter()}}})},_addIterationPicker:function(){var me=this;this.down("#iteration_selector_box").add({xtype:"rallyiterationcombobox",itemId:"iteration_selector",fieldLabel:"From iteration:",labelWidth:50,allowNoEntry:!0,listeners:{change:function(){me._populateConfigurationReporter()}}})},_addPIButton:function(){var me=this;this.down("#pi_selector_box").add({xtype:"rallybutton",text:"Choose Portfolio Item(s)",handler:me._launchPIPicker,scope:me})},_addChartButton:function(){var me=this;this.down("#chart_selector_box").add({itemId:"draw_chart_button",xtype:"rallybutton",text:"Draw Chart",disabled:!0,handler:me._getData,scope:me})},_renewState:function(){var me=this;me.logger.log(me,"_renewState()")},getState:function(){var me=this;return{selected_base_records:me._selected_base_records}},applyState:function(state){var me=this;this.thisState=state,me.logger.log(me,"ApplyState"),me.logger.log(me,"state",state)},_getData:function(){var me=this;this.down("#actual_chart_box").removeAll(),me.logger.log(me,"me._selected_base_records",me._selected_base_records),Ext.Array.each(me._selected_base_records,function(base_record){var options={pi:base_record,iteration:me._selected_iteration,iteration_start:Rally.util.DateTime.format(me.down("#iteration_start_selector").getValue(),"Y-MM-dd"),iteration_end:Rally.util.DateTime.format(me.down("#iteration_end_selector").getValue(),"Y-MM-dd"),tags:me._selected_tags,stack:me.getSetting("stackBy")};me.logger.log(me,"options",options),me._direct_children={},0===options.pi.get("PortfolioItemType").Ordinal?me.logger.log(this,"Not yet!"):options.pi.getCollection("Children",{fetch:["Tags","Children","Name","FormattedID","TypePath","PortfolioItemType","Ordinal","ObjectID",me.category_field_name]}).load({callback:function(records,operation,success){0===records.length?me.down("#actual_chart_box").add({xtype:"container",html:"No descendants: "+base_record.get("Name")}):Ext.Array.each(records,function(record){me._direct_children[record.get("FormattedID")]=record,record.set("_selected_pi",options.pi);var key=record.get("FormattedID");me._findDescendants(key,options,[record])})}})})},_populateConfigurationReporter:function(){var me=this;this.down("#actual_chart_box").removeAll();var iteration_message="In progress items regardless of iteration";me._selected_iteration&&""!==me._selected_iteration.get("Name")&&(iteration_message="In progress items associated with iterations named "+me._selected_iteration.get("Name"));var iteration_start_date=Rally.util.DateTime.format(me.down("#iteration_start_selector").getValue(),"D, M d, Y"),iteration_end_date=Rally.util.DateTime.format(me.down("#iteration_end_selector").getValue(),"D, M d, Y");iteration_start_date&&iteration_end_date?iteration_message="In progress items associated with iterations starting after "+iteration_start_date+" and ending before "+iteration_end_date:iteration_start_date?iteration_message="In progress items associated with iterations starting after "+iteration_start_date:iteration_end_date&&(iteration_message="In progress items associated with iterations ending before "+iteration_end_date),me._selected_tags=[],Ext.Array.each(this.down("#tag_selector").getValue(),function(tag){me._selected_tags.push(tag.get("Name"))});var tag_message="&nbsp;&nbsp;and regardless of tag";1===me._selected_tags.length?tag_message="&nbsp;&nbsp;and with tag named "+me._selected_tags[0]:me._selected_tags.length>1&&(tag_message="&nbsp;&nbsp;and with one of these tags: "+me._selected_tags.join(","));var metric_message="&nbsp;&nbsp;&nbsp;&nbsp;Display by "+me.getSetting("chartMetric");if(me._selected_base_records.length>0){var pi_names=[];Ext.Array.each(me._selected_base_records,function(record){pi_names.push(record.get("Name"))}),me.down("#selected_pi_box").update("For "+me.down("#type_selector").getRecord().get("ElementName")+"(s) "+pi_names.join(", ")+", find:"),me.down("#selected_metric_box").update(metric_message),me.down("#selected_iteration_box").update(iteration_message),me.down("#selected_tag_box").update(tag_message)}else me.down("#selected_pi_box").update("No PI chosen.")},_launchPIPicker:function(){var me=this;this.logger.log(this,"launch PI Picker"),this.dialog=Ext.create("Rally.ui.dialog.ChooserDialog",{artifactTypes:[me.down("#type_selector").getRecord().get("TypePath")],filterableFields:[{displayName:"ID",attributeName:"FormattedID"},{displayName:"Name",attributeName:"Name"}],columns:[{text:"id",dataIndex:"FormattedID"},{text:"Name",dataIndex:"Name",flex:1}],storeConfig:{fetch:["Children","UserStories","Name","FormattedID","TypePath","PortfolioItemType","Ordinal","ObjectID","Tags"]},autoShow:!0,height:500,title:"Choose a PI",multiple:!0,listeners:{artifactChosen:function(selectedRecord){var records=me.dialog._getSelectedRecords();me._selected_base_records=records,me._selected_base_records.length>0?me.down("#draw_chart_button").setDisabled(!1):me.down("#draw_chart_button").setDisabled(!0),me._populateConfigurationReporter()},scope:this}})},_findDescendants:function(key,options,records){var me=this;me.logger.log(this,"_findDescendants for ",key,options,records);var type_name=null;if(0===records.length)me.logger.log(this,"No path to stories",options),me._direct_children[key].set("_leaves",[]);else{var first_record=records[0],pi_level=first_record.get("PortfolioItemType").Ordinal;if(options.type_name=first_record.get("PortfolioItemType").Name,me.logger.log(this,"pi level "+pi_level),0!==pi_level){var all_children=[],callback_counter=0,no_children_found=!0;Ext.Array.each(records,function(record){var children=record.get("Children");children.Count>0&&(callback_counter+=1,no_children_found=!1,record.getCollection("Children",{fetch:["Tags","Children","Name","FormattedID","TypePath","PortfolioItemType","Ordinal","ObjectID"]}).load({callback:function(records,operation,success){Ext.Array.push(all_children,records),callback_counter-=1,me.logger.log(this,"counter "+callback_counter),0>=callback_counter&&me._findDescendants(key,options,all_children)}}))}),no_children_found&&me._findDescendants(key,options,[])}else me._limitPIsToSelectedTags(key,options,records)}},_getStories:function(key,options,records){var field_name="PortfolioItemRelease";"Release"!==options.type_name&&(field_name=options.type_name);var me=this;me.logger.log(this,"Getting stories related to "+key);var oid_filters=Ext.create("Rally.data.QueryFilter",{property:field_name+".ObjectID",operator:"=",value:records[0].get("ObjectID")});Ext.Array.each(records,function(record,idx){idx>0&&(oid_filters=oid_filters.or(Ext.create("Rally.data.QueryFilter",{property:field_name+".ObjectID",operator:"=",value:record.get("ObjectID")})))});var filters=Ext.create("Rally.data.QueryFilter",{property:"DirectChildrenCount",operator:"=",value:0});filters=filters.and(Ext.create("Rally.data.QueryFilter",{property:"ScheduleState",operator:">",value:"Defined"})),options.iteration&&""!==options.iteration.get("Name")&&(filters=filters.and(Ext.create("Rally.data.QueryFilter",{property:"Iteration.Name",value:options.iteration.get("Name")}))),options.iteration_start&&(filters=filters.and(Ext.create("Rally.data.QueryFilter",{property:"Iteration.StartDate",operator:">=",value:options.iteration_start}))),options.iteration_end&&(filters=filters.and(Ext.create("Rally.data.QueryFilter",{property:"Iteration.EndDate",operator:"<=",value:options.iteration_end}))),filters=filters.and(oid_filters),me.logger.log(this,"filters",""+filters),Ext.create("Rally.data.WsapiDataStore",{model:"UserStory",filters:filters,fetch:["Name","PlanEstimate","ScheduleState","TaskEstimateTotal"],autoLoad:!0,listeners:{load:function(store,records){me.logger.log(this,"Stories for "+key,records),me._direct_children[key].set("_leaves",records),me._direct_children[key].set("_selected_pi",options.pi);var waiter=null;for(var i in me._direct_children)me._direct_children[i].get("_leaves")||(waiter=i);me.logger.log(this,"_leaves",me._direct_children),null!==waiter?me.logger.log(this,"Still waiting for "+waiter):me._makeBarChart()}}})},_limitPIsToSelectedTags:function(key,options,records){var me=this;me.logger.log(this,"_limitPIsToSelectedTags",key,options,records);var filtered_records=[];if(0===options.tags.length)me._getStories(key,options,records);else{var callback_counter=0,any_tags_found=!1;Ext.Array.each(records,function(record){var tags=record.get("Tags");me.logger.log(this,tags,record),tags.Count>0&&(any_tags_found=!0,callback_counter+=1,record.getCollection("Tags",{fetch:["Name"]}).load({callback:function(tag_records,operation,success){me.logger.log(this,"has tags",tag_records),callback_counter-=1,me.logger.log(this,"counter "+callback_counter),Ext.Array.each(tag_records,function(tag_record){return Ext.Array.indexOf(options.tags,tag_record.get("Name"))>-1?(filtered_records.push(record),void 0):void 0}),0>=callback_counter&&(0===filtered_records.length?(me.logger.log(this,"Has tags, but not the right ones, REMOVING",key),delete me._direct_children[key]):me._getStories(key,options,filtered_records))}}))}),any_tags_found||(me.logger.log(this,"Has no tags, so REMOVING",key),delete me._direct_children[key])}},_calculateDataForChart:function(direct_children){var me=this;me.logger.log(this,"_calculateDataForChart");var chart_data={},metric=this.down("#metric_selector").getValue();return Ext.Object.each(direct_children,function(key,child){var pi_key=child.get("_selected_pi").get("Name");chart_data[pi_key]||(chart_data[pi_key]={});var data_key=child.get("Name");"category"===me.getSetting("stackBy")&&(data_key=child.get(me.category_field_name)||"Other"),chart_data[pi_key][data_key]||(chart_data[pi_key][data_key]=0);var leaves=child.get("_leaves");Ext.Array.each(leaves,function(leaf){var size=leaf.get("PlanEstimate")||0;if("count"===metric)size=1;else if("hours"===metric)size=leaf.get("TaskEstimateTotal")||0;else if("cost"===metric){var hours=leaf.get("TaskEstimateTotal")||0;size=hours*me.down("#cost_selector").getValue()}chart_data[pi_key][data_key]+=size})}),chart_data},_makeBarChart:function(){var me=this;me.logger.log(this,"_makeBarChart");var chart_data=me._calculateDataForChart(me._direct_children);if(0===Ext.Object.getKeys(chart_data).length)me.actual_chart=this.down("#actual_chart_box").add({xtype:"container",html:"No points found"});else{var series_hash=[],series=[],x_categories=[],y_categories=[];Ext.Object.each(chart_data,function(pi_key,value){x_categories.push(pi_key),y_categories=Ext.Array.merge(y_categories,Ext.Object.getKeys(value))}),y_categories=y_categories.sort(),x_categories=x_categories.sort(),Ext.Array.each(y_categories,function(category){series_hash[category]={type:"column",name:category,data:[],stack:1}}),this.logger.log(me,"x categories",x_categories),this.logger.log(me,"y categories",y_categories),this.logger.log(me,"series hash",series_hash);var x_keys=[];x_keys=Ext.Object.getKeys(chart_data).sort(),this.logger.log(me,"keys",x_keys),Ext.Array.each(x_keys,function(x_key){var record_chart_data=chart_data[x_key];Ext.Array.each(y_categories,function(category){var data_point=null;record_chart_data[category]&&(data_point=record_chart_data[category]),series_hash[category].data.push(data_point)})}),Ext.Object.each(series_hash,function(key,value){series.push(value)});var column_width=null;if(20>x_categories.length&&(column_width=60),me.logger.log(this,"length:",x_categories.length),15>x_categories.length)for(var pad_with=(15-x_categories.length)/2,i=0;pad_with>i;i++)Ext.Array.each(series,function(points){points.data.push(null),points.data.unshift(null)}),x_categories.push(""),x_categories.unshift("");me.actual_chart=this.down("#actual_chart_box").add({xtype:"rallychart",chartData:{series:series,categories:x_categories},chartConfig:{chart:{width:me.getWidth()},title:{text:"",align:"center"},xAxis:[{categories:x_categories,labels:{align:"right",rotation:-90,formatter:function(){return me._splitString(this.value,25)}}}],tooltip:{formatter:function(){var metric=me.down("#metric_selector").getValue();if("cost"===metric)return this.x+"<br/><b>"+this.series.name+"</b>: $"+this.y;var unit="";return"hours"===metric?unit="hours":"points"===metric&&(unit="points"),this.x+"<br/><b>"+this.series.name+"</b>: "+this.y+" "+unit},enabled:!0},plotOptions:{column:{stacking:"normal"},series:{groupPadding:0,pointWidth:column_width}},yAxis:[{title:{text:""}}]}})}},_splitString:function(value,len){var me=this;if(value&&value.length>len){var vs=value.substr(0,len-2),index=Math.max(vs.lastIndexOf("/"),vs.lastIndexOf(" "),vs.lastIndexOf("."),vs.lastIndexOf("!"),vs.lastIndexOf("?"));if(-1!==index&&index>=len-15){var first_part=vs.substr(0,index)+"<br/>",second_part=me._splitString(value.substr(index,len));return first_part+second_part}return value.substr(0,len-3)+"<br/>"+value.substr(len-3,len)}return value},_makePieChart:function(){var me=this;me.logger.log(this,"_makePieChart");var total_size=0,chart_data=me._calculateDataForChart(me._direct_children);Ext.Object.each(chart_data,function(key,value){total_size+=value});var series=[];Ext.Object.each(chart_data,function(key,value){var ratio=parseInt(100*value/total_size,10),name=Ext.util.Format.ellipsis(key,28,!0)+"<br/>"+ratio+"%";series.push({full_name:key,name:name,y:value})}),me.logger.log(this,"Chart Data",chart_data),me.logger.log(this,"Chart Series",series),me.actual_chart=0===total_size?this.down("#actual_chart_box").add({xtype:"container",html:"No points found"}):this.down("#actual_chart_box").add({xtype:"rallychart",width:me.getWidth(),chartConfig:{chart:{spacingRight:25,spacingLeft:5,width:me.getWidth(),height:me.getHeight()},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,distance:5,color:"#000000",connectorColor:"#000000",format:"<b>{point.name}</b>"}}},tooltip:{enabled:!1},title:{text:"Actual Distribution",align:"center"}},chartData:{series:[{type:"pie",name:"State Distribution",data:series}]}})}});

            Rally.launchApp('Tls.InvestmentCategories', {
                name:"PI State Allocation",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
